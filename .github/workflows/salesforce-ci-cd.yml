name: Salesforce CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  salesforce-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url -f auth.txt -a DevOpsPractice

      - name: Metadata Inventory
        run: |
          python scripts/python/metadata_inventory.py

      - name: Run Salesforce Code Analyzer
        uses: salesforce/code-analyzer-action@v2
        with:
            run: |
                sf code-analyzer run --target force-app --format table

      - name: Run Apex Tests
        run: |
          sf apex test run \
            --test-level RunLocalTests \
            --wait 30 \
            --target-org DevOpsPractice

      - name: Validate Deployment
        run: |
          sf project deploy start \
            --dry-run \
            --target-org DevOpsPractice

      - name: Deploy to Salesforce
        run: |
          sf project deploy start \
            --target-org DevOpsPractice

      - name: Export Org Data
        run: |
          sf data query \
            --query "SELECT Id, Name FROM Account LIMIT 10" \
            --target-org DevOpsPractice \
            --result-format csv > accounts.csv
