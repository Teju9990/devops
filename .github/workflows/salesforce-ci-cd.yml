name: Salesforce CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  salesforce-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url -f auth.txt -a DevOpsPractice

      - name: Metadata Inventory
        run: |
          python scripts/python/metadata_inventory.py

      - name: Install Latest Salesforce Code Analyzer CLI Plugin
        run: |
          sf plugins install code-analyzer@latest

      - name: Run Salesforce Code Analyzer
        id: run-code-analyzer
        uses: forcedotcom/run-code-analyzer@v2
        with:
          run-arguments: >
            --workspace .
            --view detail
            --output-file sfca_results.json
          github-token: ${{ github.token }}

      - name: Fail on Critical/High Violations (All Files)
        if: |
          steps.run-code-analyzer.outputs.exit-code > 0 ||
          steps.run-code-analyzer.outputs.num-sev1-violations > 0 ||
          steps.run-code-analyzer.outputs.num-sev2-violations > 0
        run: exit 1

      - name: Run Apex Tests
        run: |
          sf apex test run \
            --test-level RunLocalTests \
            --wait 30 \
            --target-org DevOpsPractice

      - name: Validate Deployment
        run: |
          sf project deploy start \
            --dry-run \
            --target-org DevOpsPractice

      - name: Deploy to Salesforce
        run: |
          sf project deploy start \
            --target-org DevOpsPractice

      - name: Export Org Data
        run: |
          sf data query \
            --query "SELECT Id, Name FROM Account LIMIT 10" \
            --target-org DevOpsPractice \
            --result-format csv > accounts.csv
